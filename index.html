<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Dashboard</title>
  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,0.06); --card2:rgba(255,255,255,0.08);
      --text:rgba(255,255,255,0.92); --muted:rgba(255,255,255,0.65);
      --stroke:rgba(255,255,255,0.12); --shadow:0 10px 30px rgba(0,0,0,0.35);
      --radius:18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --pos: #8cffbe; --neg: #ff8c8c; --realized: #7dd3fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(100,170,255,0.18), transparent 55%),
        radial-gradient(900px 700px at 90% 30%, rgba(180,120,255,0.14), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 48px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .pill{
      padding:8px 12px;border:1px solid var(--stroke);background:rgba(255,255,255,0.04);
      border-radius:999px;font-size:12px;color:var(--muted)
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{
      background:linear-gradient(180deg,var(--card2),var(--card));
      border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px 14px 12px; min-height:120px
    }
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-family:var(--mono)}
    .kpi .hint{font-size:11px;color:var(--muted); line-height:1.4}
    
    .span-3{grid-column:span 3}
    .span-4{grid-column:span 4} /* Modificato per layout a 3 colonne sopra */
    .span-6{grid-column:span 6}
    .span-12{grid-column:span 12}
    
    .card h2{margin:0 0 10px;font-size:14px;color:rgba(255,255,255,0.86);font-weight:650;letter-spacing:.2px}
    .chartbox{position:relative;height:320px}
    .table-wrap{max-height:420px;overflow:auto;border-radius:14px;border:1px solid var(--stroke)}
    .table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px;border:0}
    .table thead th{
      text-align:left;font-size:12px;color:var(--muted);padding:10px 10px;
      border-bottom:1px solid var(--stroke);background:rgba(255,255,255,0.04);
      position:sticky;top:0;z-index:1;white-space:nowrap
    }
    .table tbody td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px;white-space:nowrap}
    .table tbody tr:hover{background:rgba(255,255,255,0.04)}
    
    /* Stili specifici tabella chiuse */
    .closed-row { opacity: 0.7; }
    .closed-row:hover { opacity: 1; }

    .right{text-align:right}
    .tag{
      font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.78);display:inline-block
    }
    .pos{color:var(--pos);font-family:var(--mono)}
    .neg{color:var(--neg);font-family:var(--mono)}
    .realized{color:var(--realized);font-family:var(--mono);font-weight:bold;}
    .mono{font-family:var(--mono)}
    .footer{margin-top:14px;color:var(--muted);font-size:12px}
    
    .table thead th.sortable{cursor:pointer;user-select:none}
    .table thead th.sortable:hover{background:rgba(255,255,255,0.06)}
    .sort-ind{opacity:.7;margin-left:6px;font-size:11px}
    
    @media (max-width:980px){
      .span-3,.span-4,.span-6{grid-column:span 12}
      .chartbox{height:280px}
      header{align-items:flex-start;flex-direction:column}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div><h1>Portfolio Dashboard</h1></div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="pill" id="asOf">Prezzi aggiornati al: —</div>
      <a class="pill"
         href="https://docs.google.com/document/d/1sikh0ORwojUQrcuRe21prdnyXie6GrZPd_uWr_Pb9NM/edit?tab=t.0"
         target="_blank" rel="noopener" style="text-decoration:none;">
        Le mie analisi
      </a>
    </div>
  </header>

  <section class="grid" style="margin-bottom:14px;">
    <div class="card span-3 kpi">
      <div class="label">Rendimento Totale (Netto)</div>
      <div class="value" id="kpiTotal">—</div>
      <div class="hint">Include posizioni aperte e chiuse</div>
    </div>

    <div class="card span-3 kpi" style="border:1px solid rgba(125, 211, 252, 0.3);">
      <div class="label" style="color:var(--realized)">Profitto Realizzato (Incassato)</div>
      <div class="value realized" id="kpiRealized">—</div>
      <div class="hint" style="color:#a0e0ff;">
        % calcolata sul <b>capitale totale</b>,<br>non sulla singola trade.
      </div>
    </div>

    <div class="card span-3 kpi">
      <div class="label">Migliore (Aperta)</div>
      <div class="value" id="kpiBest">—</div>
      <div class="hint" id="kpiBestHint">—</div>
    </div>

    <div class="card span-3 kpi">
      <div class="label">Peggiore (Aperta)</div>
      <div class="value" id="kpiWorst">—</div>
      <div class="hint" id="kpiWorstHint">—</div>
    </div>
  </section>

  <section class="grid">
    <div class="card span-6">
      <h2>Allocazione Attuale (Peso %)</h2>
      <div class="chartbox"><canvas id="chartAlloc"></canvas></div>
    </div>

    <div class="card span-6">
      <h2>Allocazione per Asset</h2>
      <div class="chartbox"><canvas id="chartAsset"></canvas></div>
    </div>

    <div class="card span-6">
      <h2>Peso vs P&L (Posizioni Aperte)</h2>
      <div class="chartbox"><canvas id="chartScatter"></canvas></div>
    </div>

    <div class="card span-6">
      <h2>Contributo al Rendimento (punti %)</h2>
      <div class="chartbox"><canvas id="chartContrib"></canvas></div>
    </div>

    <div class="card span-12">
      <h2>Posizioni Aperte (A Mercato)</h2>
      <div class="table-wrap">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th class="sortable" data-key="Ticker">Ticker<span class="sort-ind"></span></th>
              <th class="sortable" data-key="Name">Nome<span class="sort-ind"></span></th>
              <th class="sortable" data-key="Asset">Asset<span class="sort-ind"></span></th>
              <th class="sortable" data-key="DataAcquisto">Data Acq.<span class="sort-ind"></span></th>
              <th class="right sortable" data-key="Weight">Peso %<span class="sort-ind"></span></th>
              <th class="right sortable" data-key="Entry">Prezzo Acq.<span class="sort-ind"></span></th>
              <th class="right sortable" data-key="Current">Prezzo Att.<span class="sort-ind"></span></th>
              <th class="right sortable" data-key="PnL">P&L %<span class="sort-ind"></span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer">La liquidità derivante dalle vendite è inclusa qui per mantenere il peso corretto.</div>
    </div>

    <div class="card span-12">
      <h2>Storico Operazioni Chiuse</h2>
      <div class="table-wrap">
        <table class="table" id="tblClosed">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Nome</th>
              <th>Asset</th>
              <th>Data Acq.</th>
              <th>Data Vendita</th>
              <th class="right">Peso (alla vendita)</th>
              <th class="right">Prezzo Acq.</th>
              <th class="right">Prezzo Vendita</th>
              <th class="right">P&L Trade %</th>
              <th class="right">Contributo Totale %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* =========================
   1) DATI
   ========================= */
const DATA = {
  asOf: "23/01/2026",
  
  // 1a. POSIZIONI APERTE (La liquidità ex-Gold è qui)
  table: [
    { Ticker:"EMAAR.AE",      Name:"Emaar Properties", Asset:"Stock",  Weight:36.95, Entry:13.69,     Current:15,    DataAcquisto:"23/10/2025" },
    { Ticker:"WLFI33251-USD", Name:"World Libery Financial", Asset:"Crypto", Weight:11.11, Entry:0.136853,  Current:0.172, DataAcquisto:"22/10/2025" },
    { Ticker:"ABEC.DE",       Name:"Alphabet(Google)", Asset:"Stock",  Weight:9.49,  Entry:271.88,    Current:286.4, DataAcquisto:"05/01/2026" },
    { Ticker:"AHLA.DE",       Name:"Alibaba", Asset:"Stock",  Weight:9.11,  Entry:134.49,    Current:151,   DataAcquisto:"10/12/2025" },
    { Ticker:"6RJ0.MU",       Name:"Rocket Lab", Asset:"Stock",  Weight:7.89,  Entry:52.28,     Current:75,    DataAcquisto:"16/12/2025" },
    { Ticker:"1810.HK",       Name:"Xiaomi", Asset:"Stock",  Weight:6.68,  Entry:57.90,     Current:35.24, DataAcquisto:"02/12/2025" },
    { Ticker:"MFEA.MI",       Name:"Media for Europe", Asset:"Stock",  Weight:6.22,  Entry:3.04,      Current:3.108, DataAcquisto:"01/12/2025" },
    { Ticker:"WNUC.DE",       Name:"WisdomTree Uranium", Asset:"ETF",    Weight:6.45,  Entry:46.9,      Current:57,    DataAcquisto:"12/12/2025" },
    { Ticker:"TL0.DE",        Name:"Tesla", Asset:"Stock",  Weight:3.11,  Entry:388.78,    Current:373.2, DataAcquisto:"10/12/2025" },
    { Ticker:"SIDU",          Name:"Sidus Space", Asset:"Stock",  Weight:2.88,  Entry:2.58,      Current:3.385, DataAcquisto:"31/12/2025" },
    // Cash generato dalla vendita del Gold (Peso originale mantenuto per allocazione)
    { Ticker:"CASH",          Name:"Liquidità (da vendita Gold)", Asset:"Cash", Weight:1.11,  Entry:1,         Current:1,     DataAcquisto:"23/01/2026" },
  ],

  // 1b. POSIZIONI CHIUSE
  closed: [
    { 
      Ticker:"GC=F", 
      Name:"Gold", 
      Asset:"Futures", 
      Weight:1.11,       // Peso che aveva al momento della vendita
      Entry:3990, 
      Exit:4946,         // Prezzo di chiusura
      DataAcquisto:"10/12/2025",
      DataVendita:"23/01/2026"
    }
  ]
};

/* =========================
   2) UTIL
   ========================= */
const fmt = (x, d=2) => Number(x).toLocaleString('it-IT', { minimumFractionDigits:d, maximumFractionDigits:d });

const fmtSmart = (x) => {
  const n = Number(x);
  if (!isFinite(n)) return '';
  const a = Math.abs(n);
  if (a !== 0 && a < 1) return n.toLocaleString('it-IT', { minimumFractionDigits: 3, maximumFractionDigits: 6 });
  return n.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

const computePnL = (entry, current) => {
  const e = Number(entry), c = Number(current);
  if (!isFinite(e) || e === 0 || !isFinite(c)) return 0;
  return ((c - e) / e) * 100;
};

const parseITDate = (s) => {
  if (!s) return null;
  const parts = String(s).split('/');
  if (parts.length !== 3) return null;
  const [dd, mm, yyyy] = parts.map(x => parseInt(x, 10));
  if (!dd || !mm || !yyyy) return null;
  return new Date(yyyy, mm - 1, dd).getTime();
};

const getComparable = (row, key) => {
  const v = row[key];
  if (key === 'DataAcquisto') return parseITDate(v) ?? -Infinity;
  if (key === 'Weight' || key === 'Entry' || key === 'Current' || key === 'PnL') return Number(v);
  return (v ?? '').toString().toLowerCase();
};

/* =========================
   3) LOGICA CALCOLI
   ========================= */
function recomputeRowsPnL() {
  // PnL righe aperte
  DATA.table.forEach(r => { r.PnL = computePnL(r.Entry, r.Current); });
  
  // PnL righe chiuse
  DATA.closed.forEach(r => { r.PnL = computePnL(r.Entry, r.Exit); });
}

function buildDerived() {
  const labels = DATA.table.map(r => r.Ticker);
  const weights = DATA.table.map(r => Number(r.Weight) || 0);
  const pnls = DATA.table.map(r => Number(r.PnL) || 0);

  // 1. Calcolo Rendimento Non Realizzato (Open)
  // Nota: Cash ha PnL 0, quindi non aggiunge nulla al numeratore, ma il suo peso è nel denominatore.
  const unrealizedReturn = DATA.table.reduce((acc, r) => acc + (Number(r.Weight)||0) * (Number(r.PnL)||0), 0) / 100;

  // 2. Calcolo Rendimento Realizzato (Closed)
  // Formula: Somma di (Peso * PnL_Trade / 100)
  const realizedReturn = DATA.closed.reduce((acc, r) => {
    const tradePnL = computePnL(r.Entry, r.Exit);
    const contrib = (Number(r.Weight)||0) * tradePnL / 100;
    return acc + contrib;
  }, 0);

  // Totale
  const totalReturn = unrealizedReturn + realizedReturn;

  // Best/Worst (solo tra le aperte)
  let best = null, worst = null;
  DATA.table.forEach(r => {
    // Ignoriamo Cash per best/worst
    if (r.Asset === 'Cash') return;
    if (!best || Number(r.PnL) > Number(best.PnL)) best = r;
    if (!worst || Number(r.PnL) < Number(worst.PnL)) worst = r;
  });

  // Asset allocation
  const assetMap = new Map();
  DATA.table.forEach(r => {
    const a = r.Asset ?? '';
    assetMap.set(a, (assetMap.get(a) || 0) + (Number(r.Weight) || 0));
  });
  const assetLabels = Array.from(assetMap.keys());
  const assetWeights = assetLabels.map(a => assetMap.get(a));

  // Scatter
  const scatterPoints = labels.map((t, i) => ({ 
    x: weights[i], 
    y: pnls[i], 
    label: t,
    // Se è cash lo mettiamo grigio nel grafico scatter se vuoi, ma ChartJS lo gestisce auto.
  }));

  // Contrib (Includiamo anche il Realizzato aggregato come voce? No, mostriamo il contributo delle aperte + nota)
  // Oppure possiamo aggiungere le chiuse al grafico dei contributi? 
  // Per ora manteniamo il grafico contributi coerente con la tabella active
  const contrib = labels.map((t, i) => ({ label: t, value: (weights[i] * pnls[i]) / 100 }));
  contrib.sort((a, b) => b.value - a.value);

  return {
    labels, weights, pnls,
    totalReturn,
    realizedReturn,
    nPositions: DATA.table.length,
    bestTicker: best?.Ticker ?? '—',
    bestPnL: Number(best?.PnL ?? 0),
    worstTicker: worst?.Ticker ?? '—',
    worstPnL: Number(worst?.PnL ?? 0),
    assetLabels, assetWeights,
    scatterPoints,
    contrib,
  };
}

/* =========================
   4) RENDER
   ========================= */
function renderKPI(d) {
  document.getElementById('asOf').textContent = `Prezzi aggiornati al: ${DATA.asOf || '—'}`;

  // Totale
  const totalEl = document.getElementById('kpiTotal');
  totalEl.className = 'value ' + (d.totalReturn >= 0 ? 'pos' : 'neg');
  totalEl.textContent = fmt(d.totalReturn) + '%';

  // Realizzato
  const realEl = document.getElementById('kpiRealized');
  realEl.textContent = '+' + fmt(d.realizedReturn) + '%'; 
  // Nota: ho forzato il '+' visivo, se fosse negativo andrebbe gestito logicamente.

  // Best/Worst
  document.getElementById('kpiBest').textContent = d.bestTicker;
  document.getElementById('kpiBestHint').innerHTML = `P&L: <span class="pos">${fmt(d.bestPnL)}%</span>`;

  document.getElementById('kpiWorst').textContent = d.worstTicker;
  document.getElementById('kpiWorstHint').innerHTML = `P&L: <span class="neg">${fmt(d.worstPnL)}%</span>`;
}

// Render Tabella Aperte
const tbody = document.querySelector('#tbl tbody');
const headers = Array.from(document.querySelectorAll('#tbl thead th.sortable'));
let sortKey = 'Weight';
let sortDir = 'desc';

function setIndicators() {
  headers.forEach(th => {
    const ind = th.querySelector('.sort-ind');
    if (!ind) return;
    ind.textContent = (th.dataset.key === sortKey) ? (sortDir === 'asc' ? '▲' : '▼') : '';
  });
}

function renderTable() {
  tbody.innerHTML = '';
  const sorted = DATA.table.slice().sort((a, b) => {
    const A = getComparable(a, sortKey);
    const B = getComparable(b, sortKey);
    if (A < B) return sortDir === 'asc' ? -1 : 1;
    if (A > B) return sortDir === 'asc' ? 1 : -1;
    return 0;
  });

  sorted.forEach(r => {
    const tr = document.createElement('tr');
    // Se è Cash, PnL neutro
    const isCash = r.Ticker === 'CASH';
    const pnlVal = Number(r.PnL);
    let pnlClass = pnlVal >= 0 ? 'pos' : 'neg';
    if(isCash) pnlClass = 'muted';

    tr.innerHTML =
      `<td class="mono">${r.Ticker ?? ''}</td>` +
      `<td>${r.Name ?? ''}</td>` +
      `<td><span class="tag">${r.Asset ?? ''}</span></td>` +
      `<td class="mono">${r.DataAcquisto ?? ''}</td>` +
      `<td class="right mono">${fmt(r.Weight)}</td>` +
      `<td class="right mono">${fmtSmart(r.Entry)}</td>` +
      `<td class="right mono">${fmtSmart(r.Current)}</td>` +
      `<td class="right ${pnlClass}">${isCash ? '-' : fmt(r.PnL)+'%'}</td>`;
    tbody.appendChild(tr);
  });
  setIndicators();
}

// Render Tabella Chiuse
function renderClosedTable() {
  const tb = document.querySelector('#tblClosed tbody');
  tb.innerHTML = '';
  DATA.closed.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'closed-row';
    const pnl = Number(r.PnL);
    const contrib = (r.Weight * pnl) / 100;
    
    tr.innerHTML = 
      `<td class="mono">${r.Ticker}</td>` +
      `<td>${r.Name}</td>` +
      `<td><span class="tag">${r.Asset}</span></td>` +
      `<td class="mono">${r.DataAcquisto}</td>` +
      `<td class="mono">${r.DataVendita}</td>` +
      `<td class="right mono">${fmt(r.Weight)}%</td>` +
      `<td class="right mono">${fmtSmart(r.Entry)}</td>` +
      `<td class="right mono">${fmtSmart(r.Exit)}</td>` +
      `<td class="right ${pnl>=0?'pos':'neg'}">${fmt(pnl)}%</td>` +
      `<td class="right realized">+${fmt(contrib)}%</td>`;
    tb.appendChild(tr);
  });
}

headers.forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) {
      sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
    } else {
      sortKey = key;
      sortDir = (key === 'Name' || key === 'Asset' || key === 'Ticker' || key === 'DataAcquisto') ? 'asc' : 'desc';
    }
    renderTable();
  });
});

/* =========================
   5) GRAFICI
   ========================= */
const common = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      labels: { color: 'rgba(255,255,255,0.82)', boxWidth: 10, font: { size: 11 } }
    }
  },
  scales: {
    x: { ticks: { color:'rgba(255,255,255,0.7)' }, grid: { color:'rgba(255,255,255,0.08)' } },
    y: { ticks: { color:'rgba(255,255,255,0.7)' }, grid: { color:'rgba(255,255,255,0.08)' } }
  }
};

const palette = ["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#1F77B4","#2CA02C"];

let chartAlloc, chartAsset, chartScatter, chartContrib;

function initCharts(d) {
  chartAlloc = new Chart(document.getElementById('chartAlloc'), {
    type: 'doughnut',
    data: {
      labels: d.labels,
      datasets: [{
        data: d.weights,
        backgroundColor: palette,
        borderColor: 'rgba(255,255,255,0.08)',
        borderWidth: 1
      }]
    },
    options: {
      ...common,
      cutout: '58%',
      plugins: { ...common.plugins, tooltip: { callbacks: { label: (c) => ` ${c.label}: ${fmt(c.parsed)}%` } } }
    }
  });

  chartAsset = new Chart(document.getElementById('chartAsset'), {
    type: 'bar',
    data: { labels: d.assetLabels, datasets: [{ label:'Peso %', data: d.assetWeights, borderWidth: 0 }] },
    options: {
      ...common,
      plugins: { ...common.plugins, legend: { display:false }, tooltip: { callbacks: { label: (c) => ` ${fmt(c.parsed.y)}%` } } },
      scales: {
        x: { ticks: { color:'rgba(255,255,255,0.7)' }, grid:{ color:'rgba(255,255,255,0.08)' } },
        y: { ticks: { color:'rgba(255,255,255,0.7)', callback:(v)=> v+'%' }, grid:{ color:'rgba(255,255,255,0.08)' } }
      }
    }
  });

  chartScatter = new Chart(document.getElementById('chartScatter'), {
    type: 'scatter',
    data: { datasets: [{ label:'Posizioni', data: d.scatterPoints, pointRadius: 5, pointHoverRadius: 7 }] },
    options: {
      ...common,
      plugins: {
        ...common.plugins,
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const p = ctx.raw;
              return ` ${p.label} · Peso: ${fmt(p.x)}% · P&L: ${fmt(p.y)}%`;
            }
          }
        }
      },
      scales: {
        x: { title: { display:true, text:'Peso %', color:'rgba(255,255,255,0.78)' }, ticks: { color:'rgba(255,255,255,0.7)' }, grid: { color:'rgba(255,255,255,0.08)' } },
        y: { title: { display:true, text:'P&L %', color:'rgba(255,255,255,0.78)' }, ticks: { color:'rgba(255,255,255,0.7)' }, grid: { color:'rgba(255,255,255,0.08)' } }
      }
    }
  });

  chartContrib = new Chart(document.getElementById('chartContrib'), {
    type: 'bar',
    data: {
      labels: d.contrib.map(x => x.label),
      datasets: [{ label:'Contributo (punti %)', data: d.contrib.map(x => x.value), borderWidth: 0 }]
    },
    options: {
      ...common,
      plugins: { ...common.plugins, legend: { display:false }, tooltip: { callbacks: { label: (c) => ` ${fmt(c.parsed.y, 2)} punti %` } } },
      scales: {
        x: { ticks: { color:'rgba(255,255,255,0.7)' }, grid:{ color:'rgba(255,255,255,0.08)' } },
        y: { title: { display:true, text:'Punti %', color:'rgba(255,255,255,0.78)' }, ticks: { color:'rgba(255,255,255,0.7)' }, grid: { color:'rgba(255,255,255,0.08)' } }
      }
    }
  });
}

function updateCharts(d) {
  chartAlloc.data.labels = d.labels;
  chartAlloc.data.datasets[0].data = d.weights;
  chartAsset.data.labels = d.assetLabels;
  chartAsset.data.datasets[0].data = d.assetWeights;
  chartScatter.data.datasets[0].data = d.scatterPoints;
  chartContrib.data.labels = d.contrib.map(x => x.label);
  chartContrib.data.datasets[0].data = d.contrib.map(x => x.value);

  chartAlloc.update();
  chartAsset.update();
  chartScatter.update();
  chartContrib.update();
}

/* =========================
   6) BOOT
   ========================= */
function rebuildAll() {
  recomputeRowsPnL();
  const d = buildDerived();
  renderKPI(d);
  renderTable();
  renderClosedTable(); // Renderizza la nuova tabella

  if (!chartAlloc) initCharts(d);
  else updateCharts(d);
}

rebuildAll();
</script>
</body>
</html>
